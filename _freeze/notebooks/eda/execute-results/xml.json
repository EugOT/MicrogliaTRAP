{
  "hash": "2f65cf7d334b2e414573c7854486438e",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Comprehensive analysis of hypothalamic microglia across multiple datasets\"\nauthor: \"Evgenii O. Tretiakov\"\ndate: \"2025-02-06\"\nformat:\n  html:\n    code-fold: true\n    comments:\n      hypothesis: true\n    citations-hover: true\n    crossrefs-hover: true\n    title-block-style: manuscript\n    self-contained: true\n  docx: default\n  jats: default\n  pdf:\n    keep-tex: true\n    fig-dpi: 300\n    colorlinks: true\njupyter: python3\n---\n\n::: {#setup .cell .hidden execution_count=1}\n``` {}\n#| label: setup\n#| include: false\n# Set random seeds for reproducibility\nimport random\nimport numpy as np\nimport scanpy as sc\n\nrandom.seed(42)\nnp.random.seed(42)\nsc.settings.seed = 42\n\n# Other imports\nimport os\nimport pandas as pd\nfrom pathlib import Path\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom scipy import stats\nimport statsmodels.stats.multitest as mt\n```\n:::\n\n\n::: {#load-data .cell execution_count=2}\n``` {}\n#| label: load-data\n# Microglia markers based on literature\nmicroglia_markers = [\n    \"Trem2\", \"Aif1\", \"Itgam\", \"Cx3cr1\", \"P2ry12\",\n    \"Tmem119\", \"Hexb\", \"Csf1r\", \"C1qa\", \"C1qb\", \"C1qc\",\n    \"Cd68\", \"Ptprc\", \"Fcrls\", \"Cd14\", \"Tgfbr1\", \"Sall1\",\n    \"Olfml3\", \"Siglech\", \"Gpr34\", \"Mafb\", \"Cd33\"\n]\n\n# Create dataset mapping\ndataset_info = {\n    'PRJNA1018579': {'name': 'Guo2024_POA', 'region': 'POA'},\n    'PRJNA971261': {'name': 'Jovanovic2022_DMH', 'region': 'DMH'},\n    'PRJNA872019': {'name': 'Tang2023_DMH_SCN', 'region': 'DMH_SCN'},  # Taking first region\n    'PRJNA847050': {'name': 'lutomska2022_Arc', 'region': 'Arc'},\n    'PRJNA815819': {'name': 'pool2022_MnPO', 'region': 'MnPO'},\n    'PRJNA798401': {'name': 'liu2022_VMHvl', 'region': 'VMHvl'},\n    'PRJNA779749': {'name': 'hajdarovic2022_Hypoth', 'region': 'Hypoth'},\n    'PRJNA723345': {'name': 'rupp2021_MBH', 'region': 'MBH'},\n    'PRJNA722418': {'name': 'affinati2021_VMH', 'region': 'VMH'},\n    'PRJNA705596': {'name': 'morris2021_SCN', 'region': 'SCN'},\n    'PRJNA679294': {'name': 'lopez2021_PVN', 'region': 'PVN'},\n    'PRJNA626601': {'name': 'Bentsen2020_MBH', 'region': 'MBH'},  # Taking first region\n    'PRJNA611624': {'name': 'mickelsen2020_VPH', 'region': 'VPH'},\n    'PRJNA604055': {'name': 'deng2020_Arc', 'region': 'Arc'},\n    'PRJNA548917': {'name': 'romanov2020_Hypoth', 'region': 'Hypoth-dev'},\n    'PRJNA548532': {'name': 'wen2020_SCN', 'region': 'SCN'},\n    'PRJNA547712': {'name': 'kim2020_Hypoth', 'region': 'Hypoth-dev'},\n    'PRJNA515063': {'name': 'mickelsen2019_LHA', 'region': 'LHA'},\n    'PRJNA453138': {'name': 'moffitt2018_POA', 'region': 'POA'},\n    'PRJNA438862': {'name': 'zeisel2018_Hypoth', 'region': 'Hypoth-brain'}\n}\n\n# Function to load and preprocess dataset\ndef load_dataset(file_path):\n    adata = sc.read_h5ad(file_path)\n    project = Path(file_path).stem.split('-')[0]\n    \n    # Add dataset name and region information\n    if project in dataset_info:\n        adata.obs['dataset'] = dataset_info[project]['name']\n        adata.obs['region'] = dataset_info[project]['region']\n    else:\n        adata.obs['dataset'] = project\n        adata.obs['region'] = 'Unknown'\n    \n    return adata\n\n# Load all datasets\ndata_dir = Path(\"/home/etretiakov/src/MicrogliaTRAP/data/\")\ndatasets = []\nfor file in data_dir.glob(\"*-whole.h5ad\"):\n    print(f\"Loading {file.name}\")\n    datasets.append(load_dataset(file))\n\n# Concatenate all datasets\nadata_combined = datasets[0].concatenate(\n    datasets[1:],\n    join='outer',\n    batch_key='dataset'\n)\n\nprint(f\"Combined dataset shape: {adata_combined.shape}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLoading PRJNA847050-whole.h5ad\nLoading PRJNA815819-whole.h5ad\nLoading PRJNA798401-whole.h5ad\nLoading PRJNA723345-whole.h5ad\nLoading PRJNA722418-whole.h5ad\nLoading PRJNA705596-whole.h5ad\nLoading PRJNA679294-whole.h5ad\nLoading PRJNA611624-whole.h5ad\nLoading PRJNA604055-whole.h5ad\nLoading PRJNA548532-whole.h5ad\nLoading PRJNA515063-whole.h5ad\nLoading PRJNA453138-whole.h5ad\n```\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\n/tmp/ipykernel_27977/1715800184.py:56: FutureWarning:\n\nUse anndata.concat instead of AnnData.concatenate, AnnData.concatenate is deprecated and will be removed in the future. See the tutorial for concat at: https://anndata.readthedocs.io/en/latest/concatenation.html\n\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nCombined dataset shape: (271739, 27597)\n```\n:::\n:::\n\n\n::: {#exclude-sex-genes .cell execution_count=3}\n``` {}\n#| label: exclude-sex-genes\n# Exclude sex-specific genes from the combined dataset\n\nsex_specific_genes = [\n    \"Ehd2\", \"Espl1\", \"Jarid1d\", \"Pnpla4\",\n    \"Rps4y1\", \"Xist\", \"Tsix\", \"Eif2s3y\",\n    \"Ddx3y\", \"Uty\", \"Kdm5d\"\n]\n\n# Identify which sex-specific genes are present in the dataset\npresent_sex_genes = [gene for gene in sex_specific_genes if gene in adata_combined.var_names]\n\nif present_sex_genes:\n    print(f\"Excluding sex-specific genes: {present_sex_genes}\")\n    # Remove these genes from the dataset\n    adata_combined = adata_combined[:, ~adata_combined.var_names.isin(present_sex_genes)]\nelse:\n    print(\"No sex-specific genes found to exclude.\")\n\nprint(f\"Updated dataset shape after exclusion: {adata_combined.shape}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nExcluding sex-specific genes: ['Ehd2', 'Espl1', 'Xist', 'Tsix', 'Eif2s3y', 'Ddx3y', 'Uty', 'Kdm5d']\nUpdated dataset shape after exclusion: (271739, 27589)\n```\n:::\n:::\n\n\n::: {#cell-filter-microglia .cell execution_count=4}\n``` {}\n#| label: filter-microglia\n# Define positive marker lists based on recommendations.\n\n# Primary markers with high microglia specificity.\nprimary_markers = [\"P2ry12\", \"Tmem119\", \"Siglech\", \"Fcrls\", \"Gpr34\", \"Hexb\"]\n\n# Secondary (supportive) markers.\nsecondary_markers = [\"Trem2\", \"Aif1\", \"Sall1\"]\n\n# Define a list of negative markers (any detected expression is disallowed).\nnegative_markers = [\n    \"Snap25\", \"Rbfox3\", \"Dlx5\", \"Elavl4\", \"Stmn2\", \"Snap25\", \"Th\", \"Slc17a6\",\n    \"Gad1\", \"Gad2\", \"Npy\", \"Agrp\", \"Crh\", \"Trh\", \"Avp\", \"Pomc\",\n    \"Hcrt\", \"Oxt\", \"Vim\", \"Nes\", \"Enkur\", \"Foxj1\", \"Kif6\", \"Kif9\",\n    \"Hydin\", \"Mog\", \"Mbp\", \"Plp1\", \"Cnp\", \"Mag\", \"Opalin\", \"Sox10\", \"Olig1\",\n    \"Olig2\", \"Pdgfra\", \"Pdgfrb\", \"Gpr17\", \"Ugt8a\", \"Sema3c\", \"Sema4d\",\n    \"Sema4f\", \"Gpr37\", \"Cspg4\", \"Lingo1\", \"Rgs5\", \"Des\", \"Acta2\", \"Pecam1\",\n    \"Cldn5\", \"Cd248\", \"Myh11\", \"Cdh5\", \"Fgf10\", \"Rax\", \"Gfap\", \"Aldh1l1\",\n    \"Aqp4\", \"Agt\", \"Gja1\", \"Hepacam\", \"Htra1\", \"Ndrg2\", \"Ntsr2\", \"Ntrk2\", \n    \"Slc1a3\", \"Slc6a11\", \"Slc1a2\", \"Apoe\", \"Adcyap1r1\"\n]\n\ndef identify_microglia(adata, pos_thresh=1, score_cutoff=0.6):\n    \"\"\"\n    Identify hypothalamic microglia based on a composite positive marker score \n    and strict negative marker filtering.\n\n    The composite score is computed as:\n    \n      composite_score = 0.6*(primary score) + 0.4*(secondary score) +\n                        0.3*(annotation indicator) - 0.3*(negative indicator)\n    \n    A cell is retained as microglia only if:\n     1. composite_score >= score_cutoff, AND \n     2. It expresses no negative markers (i.e. negative indicator == 0).\n\n    Parameters:\n    -----------\n    adata : AnnData\n        The combined dataset.\n    pos_thresh : float, default 1\n        Threshold to consider a positive-marker gene as \"expressed\".\n    score_cutoff : float, default 0.6\n        Minimum composite score to call a cell microglia.\n\n    Returns:\n    --------\n    microglia_flag : np.ndarray (bool)\n        Boolean vector indicating which cells qualify as microglia.\n    \"\"\"\n    n_cells = adata.n_obs\n    \n    # Calculate primary positive score.\n    pos_markers_use = [m for m in primary_markers if m in adata.var_names]\n    if pos_markers_use:\n        pos_expr = adata[:, pos_markers_use].X.toarray()\n        pos_detect = pos_expr > pos_thresh\n        pos_score = np.mean(pos_detect, axis=1)\n    else:\n        pos_score = np.zeros(n_cells)\n    \n    # Calculate secondary positive score.\n    sec_markers_use = [m for m in secondary_markers if m in adata.var_names]\n    if sec_markers_use:\n        sec_expr = adata[:, sec_markers_use].X.toarray()\n        sec_detect = sec_expr > pos_thresh\n        sec_score = np.mean(sec_detect, axis=1)\n    else:\n        sec_score = np.zeros(n_cells)\n    \n    # Add the annotation indicator based on existing cell-type annotation.\n    # This gives a bonus if a cell is annotated as 'Microglia'.\n    if 'ora_celltype' in adata.obs.columns:\n        annotation_indicator = adata.obs['ora_celltype'].isin(['Microglia']).astype(int).to_numpy()\n    else:\n        annotation_indicator = np.zeros(n_cells, dtype=int)\n    \n    # Compute the negative indicator based on the negative marker list.\n    # If any negative marker is expressed (expression > 0), mark the cell as negative.\n    neg_markers_use = [m for m in negative_markers if m in adata.var_names]\n    if neg_markers_use:\n        neg_expr = adata[:, neg_markers_use].X.toarray()\n        negative_indicator = (np.sum(neg_expr > 1, axis=1) > 0).astype(int)\n    else:\n        negative_indicator = np.zeros(n_cells, dtype=int)\n    \n    # Compute the composite score.\n    composite_score = (\n        0.6 * pos_score +\n        0.4 * sec_score +\n        0.3 * annotation_indicator -\n        0.3 * negative_indicator\n    )\n    \n    # Final decision: allow cells that meet the composite score cutoff AND\n    # have no detectable negative markers.\n    microglia_flag = (composite_score >= score_cutoff) & (negative_indicator == 0)\n    \n    return microglia_flag\n\n# Apply microglia identification to subset the combined dataset.\nis_microglia = identify_microglia(adata_combined, pos_thresh=1, score_cutoff=0.3)\nadata_microglia = adata_combined[is_microglia].copy()\n\n# Optionally filter genes expressed in fewer than 3 cells.\nsc.pp.filter_genes(adata_microglia, min_cells=3)\n\nprint(f\"Number of identified microglia: {adata_microglia.n_obs}\")\nadata_microglia\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nNumber of identified microglia: 3108\n```\n:::\n\n::: {#filter-microglia .cell-output .cell-output-display execution_count=34}\n```\nAnnData object with n_obs × n_vars = 3108 × 16934\n    obs: 'nCount_RAW', 'nFeature_RAW', 'nCount_RNA', 'nFeature_RNA', 'orig.ident', 'nFeature_Diff', 'nCount_Diff', 'percent_mito', 'percent_ribo', 'percent_mito_ribo', 'percent_hb', 'log10GenesPerUMI', 'cell_name', 'barcode', 'latent_RT_efficiency', 'latent_cell_probability', 'latent_scale', 'doublet_score', 'predicted_doublets', 'QC', 'var_regex', 'RNA_snn_res.0.5', 'RNA_snn_res.0.71728703859461', 'RNA_snn_res.1.18939286532015', 'RNA_snn_res.3.00000100000001', 'seurat_clusters', 'k_tree', 'comb_clstr1', 'S.Score', 'G2M.Score', 'Phase', 'nCount_SCT', 'nFeature_SCT', 'SCT_snn_res.1', 'SCT_snn_res.1.10031502002514', 'SCT_snn_res.1.2198400795032', 'SCT_snn_res.1.36467746508232', 'SCT_snn_res.1.54382016547197', 'SCT_snn_res.1.77109349840298', 'SCT_snn_res.2.0689045782524', 'SCT_snn_res.2.47612417203789', 'SCT_snn_res.3.06661007679595', 'SCT_snn_res.4.00000100000002', 'bioproject', 'project', 'model', 'tech', 'region', 'sex', 'stage', 'libname', 'expbtch', 'condit', 'ora_celltype', 'dataset', 'RNA_snn_res.0.7833532337729', 'RNA_snn_res.1.34581556090209', 'RNA_snn_res.3.00000099999999', 'SCT_snn_res.1.1195017969378', 'SCT_snn_res.1.25982585876617', 'SCT_snn_res.1.42693374118546', 'SCT_snn_res.1.62930288316738', 'SCT_snn_res.1.87941033125915', 'SCT_snn_res.2.19640689228103', 'SCT_snn_res.2.61126801427803', 'SCT_snn_res.3.17758609834753', 'SCT_snn_res.4.00000099999999', 'RNA_snn_res.0.698827671570266', 'RNA_snn_res.1.14210811409567', 'RNA_snn_res.3.000001', 'SCT_snn_res.0.999999999999997', 'SCT_snn_res.1.09319962188338', 'SCT_snn_res.1.20484562360462', 'SCT_snn_res.1.34101594133873', 'SCT_snn_res.1.51078813819985', 'SCT_snn_res.1.72835035395428', 'SCT_snn_res.2.01718692442895', 'SCT_snn_res.2.41918351048971', 'SCT_snn_res.3.0170408266799', 'SCT_snn_res.4.00000099999996', 'RNA_snn_res.0.707029299856434', 'RNA_snn_res.1.1633242093704', 'SCT_snn_res.1.09624280410035', 'SCT_snn_res.1.21126934615096', 'SCT_snn_res.1.35117332239486', 'SCT_snn_res.1.52500385828604', 'SCT_snn_res.1.74680444979064', 'SCT_snn_res.2.03961008405947', 'SCT_snn_res.2.44401470896301', 'SCT_snn_res.3.03884118600469', 'SCT_snn_res.4.00000100000001', 'RNA_snn_res.0.708696581250639', 'RNA_snn_res.1.16759631065218', 'SCT_snn_res.1.09433786568445', 'SCT_snn_res.1.20725017884265', 'SCT_snn_res.1.34482172774405', 'SCT_snn_res.1.51612084028104', 'SCT_snn_res.1.73528349845721', 'SCT_snn_res.2.02562815606513', 'SCT_snn_res.2.42855725849532', 'SCT_snn_res.3.0253042516118', 'SCT_snn_res.4.00000099999998', 'RNA_snn_res.0.705441838230003', 'RNA_snn_res.1.15924388679526', 'SCT_snn_res.1.09500080295337', 'SCT_snn_res.1.20864960390776', 'SCT_snn_res.1.3470346521921', 'SCT_snn_res.1.51921811960968', 'SCT_snn_res.1.73930452831673', 'SCT_snn_res.2.03051449026752', 'SCT_snn_res.2.43396901815984', 'SCT_snn_res.3.03005626315964', 'RNA_snn_res.0.741576329532297', 'RNA_snn_res.1.24913691074005', 'SCT_snn_res.1.1014548330962', 'SCT_snn_res.1.22223389211258', 'SCT_snn_res.1.36843938820807', 'SCT_snn_res.1.54904506877152', 'SCT_snn_res.1.7778105049838', 'SCT_snn_res.2.07696233957953', 'SCT_snn_res.2.48489124123347', 'SCT_snn_res.3.07411084005006', 'RNA_snn_res.0.711555907125606', 'RNA_snn_res.1.17489106681439', 'RNA_snn_res.3.00000100000003', 'SCT_snn_res.1.0985609300296', 'SCT_snn_res.1.21615179101811', 'SCT_snn_res.1.35887288645706', 'SCT_snn_res.1.53574384326226', 'SCT_snn_res.1.76068724753414', 'SCT_snn_res.2.0563840713167', 'SCT_snn_res.2.46244607013394', 'SCT_snn_res.3.0548384262319', 'SCT_snn_res.4.000001', 'RNA_snn_res.0.500000000000001', 'RNA_snn_res.0.714537899864968', 'RNA_snn_res.1.18245636371332', 'SCT_snn_res.1.09970413655729', 'SCT_snn_res.1.21855619110534', 'SCT_snn_res.1.36265805049213', 'SCT_snn_res.1.54101239385786', 'SCT_snn_res.1.76747896076642', 'SCT_snn_res.2.0645607899466', 'SCT_snn_res.2.47138643622271', 'SCT_snn_res.3.06254226682124', 'RNA_snn_res.0.714828088225169', 'RNA_snn_res.1.18319027145631', 'SCT_snn_res.1.10041167834265', 'SCT_snn_res.1.22004316637797', 'SCT_snn_res.1.36499678574129', 'SCT_snn_res.1.54426395182734', 'SCT_snn_res.1.77166448326459', 'SCT_snn_res.2.06959026449618', 'SCT_snn_res.2.47687130268825', 'SCT_snn_res.3.06725063816584', 'RNA_snn_res.0.74082856775745', 'RNA_snn_res.1.24733796060143', 'SCT_snn_res.1.10569909553377', 'SCT_snn_res.1.23112793047964', 'SCT_snn_res.1.38237925427927', 'SCT_snn_res.1.5683423560766', 'SCT_snn_res.1.80251553997986', 'SCT_snn_res.2.10643815972253', 'SCT_snn_res.2.51672603000175', 'SCT_snn_res.3.10106021549219', 'RNA_snn_res.0.499999999999999', 'RNA_snn_res.0.703209964322742', 'RNA_snn_res.1.15348606507044', 'SCT_snn_res.1.0936256603853', 'SCT_snn_res.1.20574589974601', 'SCT_snn_res.1.3424413542897', 'SCT_snn_res.1.51278632954032', 'SCT_snn_res.1.73094972121659', 'SCT_snn_res.2.02035409535935', 'SCT_snn_res.2.42270425865078', 'SCT_snn_res.3.02014937772602'\n    var: 'vst.mean-0', 'vst.variance-0', 'vst.variance.expected-0', 'vst.variance.standardized-0', 'vst.variable-0', 'vst.mean-1', 'vst.variance-1', 'vst.variance.expected-1', 'vst.variance.standardized-1', 'vst.variable-1', 'vst.mean-10', 'vst.variance-10', 'vst.variance.expected-10', 'vst.variance.standardized-10', 'vst.variable-10', 'vst.mean-11', 'vst.variance-11', 'vst.variance.expected-11', 'vst.variance.standardized-11', 'vst.variable-11', 'vst.mean-2', 'vst.variance-2', 'vst.variance.expected-2', 'vst.variance.standardized-2', 'vst.variable-2', 'vst.mean-3', 'vst.variance-3', 'vst.variance.expected-3', 'vst.variance.standardized-3', 'vst.variable-3', 'vst.mean-4', 'vst.variance-4', 'vst.variance.expected-4', 'vst.variance.standardized-4', 'vst.variable-4', 'vst.mean-5', 'vst.variance-5', 'vst.variance.expected-5', 'vst.variance.standardized-5', 'vst.variable-5', 'vst.mean-6', 'vst.variance-6', 'vst.variance.expected-6', 'vst.variance.standardized-6', 'vst.variable-6', 'vst.mean-7', 'vst.variance-7', 'vst.variance.expected-7', 'vst.variance.standardized-7', 'vst.variable-7', 'vst.mean-8', 'vst.variance-8', 'vst.variance.expected-8', 'vst.variance.standardized-8', 'vst.variable-8', 'vst.mean-9', 'vst.variance-9', 'vst.variance.expected-9', 'vst.variance.standardized-9', 'vst.variable-9', 'n_cells'\n    obsm: 'X_pacmap', 'X_pca', 'X_umap', 'ora_estimate', 'ora_pvals'\n```\n:::\n:::\n\n\n::: {#preprocess-microglia .cell execution_count=5}\n``` {}\n#| label: preprocess-microglia\n#| code-summary: Normalize and process microglial expression data\nadata_microglia.layers[\"counts\"] = adata_microglia.X.copy()\n# Normalize and process\n\n# Normalizing to median total counts\nsc.pp.normalize_total(adata_microglia)\n# Logarithmize the data\nsc.pp.log1p(adata_microglia)\nsc.pp.highly_variable_genes(\n    adata_microglia,\n    n_top_genes=2000,\n    batch_key='bioproject'\n)\n\n# Run PCA\nsc.pp.scale(adata_microglia)\nadata_microglia.layers[\"scaled\"] = adata_microglia.X.copy()\nsc.tl.pca(adata_microglia)\n```\n:::\n\n\n::: {#cell-fig-pca-bioproject .cell execution_count=6}\n``` {}\n#| label: fig-pca-bioproject\nsc.pl.pca(\n    adata_microglia,\n    color=[\"bioproject\", \"bioproject\", \"percent_mito_ribo\", \"percent_mito_ribo\"],\n    dimensions=[(0, 1), (2, 3), (0, 1), (2, 3)],\n    ncols=2,\n    size=2,\n    wspace=0.8,\n);\n```\n\n::: {.cell-output .cell-output-display}\n![](eda_files/figure-jats/fig-pca-bioproject-output-1.png){#fig-pca-bioproject}\n:::\n:::\n\n\n::: {#cell-fig-pca-region .cell execution_count=7}\n``` {}\n#| label: fig-pca-region\nsc.pl.pca(\n    adata_microglia,\n    color=[\"region\", \"region\", \"percent_mito_ribo\", \"percent_mito_ribo\"],\n    dimensions=[(0, 1), (2, 3), (0, 1), (2, 3)],\n    ncols=2,\n    size=2,\n    wspace=0.8,\n);\n```\n\n::: {.cell-output .cell-output-display}\n![](eda_files/figure-jats/fig-pca-region-output-1.png){#fig-pca-region}\n:::\n:::\n\n\n::: {#cell-fig-initial-clustering .cell execution_count=8}\n``` {}\n#| label: fig-initial-clustering\n#| fig-cap: Initial clustering analysis of hypothalamic microglia. (A) UMAP visualization colored by dataset origin shows batch effects before integration. (B) Initial Leiden clustering reveals potential microglial subpopulations. Colors represent distinct clusters identified by the algorithm.\n# Run UMAP and clustering\nsc.pp.neighbors(adata_microglia)\nsc.tl.umap(adata_microglia)\nsc.tl.leiden(adata_microglia)\n\n# Plot results\nfig, (ax1, ax2) = plt.subplots(1, 2, figsize=(18, 10))\nsc.pl.umap(adata_microglia, color='bioproject', legend_loc=\"best\", ax=ax1, show=False, title='Dataset Distribution')\nsc.pl.umap(adata_microglia, color='leiden', legend_loc=\"on data\", ax=ax2, show=False, title='Initial Clustering')\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Initial clustering analysis of hypothalamic microglia. (A) UMAP visualization colored by dataset origin shows batch effects before integration. (B) Initial Leiden clustering reveals potential microglial subpopulations. Colors represent distinct clusters identified by the algorithm.](eda_files/figure-jats/fig-initial-clustering-output-1.png){#fig-initial-clustering}\n:::\n:::\n\n\n::: {#cell-fig-marker-expression .cell execution_count=9}\n``` {}\n#| label: fig-marker-expression\n#| fig-cap: Expression patterns of canonical microglial markers across identified clusters. UMAP visualizations showing the distribution of key microglial marker genes, revealing heterogeneous expression patterns across the population before integration.\n# Plot marker genes\nsc.pl.umap(\n    adata_microglia,\n    color=microglia_markers,\n    frameon=False,\n    show=True,\n    save='_init_markers.pdf'\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nWARNING: saving figure to file figures/umap_init_markers.pdf\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Expression patterns of canonical microglial markers across identified clusters. UMAP visualizations showing the distribution of key microglial marker genes, revealing heterogeneous expression patterns across the population before integration.](eda_files/figure-jats/fig-marker-expression-output-2.png){#fig-marker-expression}\n:::\n:::\n\n\n::: {#integrate-datasets .cell execution_count=10}\n``` {}\n#| label: integrate-datasets\n#| code-summary: Perform integration\n# Harmony integration\nimport harmonypy\n\nsc.external.pp.harmony_integrate(\n    adata_microglia,\n    'bioproject',\n    max_iter_harmony=20\n)\n\n# Recompute UMAP on integrated data\nsc.pp.neighbors(adata_microglia, use_rep='X_pca_harmony')\nsc.tl.umap(adata_microglia)\nsc.tl.leiden(adata_microglia, key_added='leiden_integrated')\nsc.tl.embedding_density(adata_microglia, basis='umap', groupby='leiden_integrated')\nsc.tl.embedding_density(adata_microglia, basis='umap', groupby='region')\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\n2025-02-06 11:40:05,738 - harmonypy - INFO - Computing initial centroids with sklearn.KMeans...\n2025-02-06 11:40:16,288 - harmonypy - INFO - sklearn.KMeans initialization complete.\n2025-02-06 11:40:16,387 - harmonypy - INFO - Iteration 1 of 20\n2025-02-06 11:40:31,788 - harmonypy - INFO - Iteration 2 of 20\n2025-02-06 11:40:48,387 - harmonypy - INFO - Converged after 2 iterations\n```\n:::\n:::\n\n\n::: {#cell-fig-integrated-analysis .cell execution_count=11}\n``` {}\n#| label: fig-integrated-analysis\n#| fig-cap: Analysis of batch-corrected microglial data. (A) UMAP visualization after integration shows reduced batch effects. (B) Refined clustering based on integrated data reveals distinct microglial subpopulations. (C) Distribution of cells by hypothalamic region demonstrates regional heterogeneity of microglia.\nsc.pl.umap(adata_microglia, color=['bioproject', 'region', 'leiden_integrated'], title=['Integrated Datasets', 'Regional Distribution', 'Integrated Clusters'], legend_loc=\"right margin\", wspace=.8, hspace=.8, size=5, ncols = 2);\n```\n\n::: {.cell-output .cell-output-display}\n![Analysis of batch-corrected microglial data. (A) UMAP visualization after integration shows reduced batch effects. (B) Refined clustering based on integrated data reveals distinct microglial subpopulations. (C) Distribution of cells by hypothalamic region demonstrates regional heterogeneity of microglia.](eda_files/figure-jats/fig-integrated-analysis-output-1.png){#fig-integrated-analysis}\n:::\n:::\n\n\n::: {#save-integrated-analysis .cell execution_count=12}\n``` {}\n#| label: save-integrated-analysis\n# Dataset distribution after integration\nsc.pl.umap(\n    adata_microglia,\n    color='bioproject',\n    show=False,\n    title='Integrated Datasets',\n    save='_integrated_datasets.pdf'\n);\n\n# Integrated clustering\nsc.pl.umap(\n    adata_microglia,\n    color='leiden_integrated',\n    show=False,\n    legend_loc=\"on data\",\n    title='Integrated Clusters',\n    save='_integrated_clusters.pdf'\n);\n\n# Regional distribution\nsc.pl.umap(\n    adata_microglia,\n    color='region',\n    show=False,\n    title='Regional Distribution',\n    save='_integrated_regions.pdf'\n);\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nWARNING: saving figure to file figures/umap_integrated_datasets.pdf\nWARNING: saving figure to file figures/umap_integrated_clusters.pdf\nWARNING: saving figure to file figures/umap_integrated_regions.pdf\n```\n:::\n:::\n\n\n::: {#cell-fig-cluster-markers .cell execution_count=13}\n``` {}\n#| label: fig-cluster-markers\n#| fig-cap: Differential expression analysis of integrated clusters. Plot shows the top 25 differentially expressed genes per cluster identified using Wilcoxon rank-sum test. Genes are ordered by average log fold change, and expression values are z-scored per gene.\n#| warning: false\n# Find markers for each cluster\nsc.tl.rank_genes_groups(\n    adata_microglia,\n    'leiden_integrated',\n    method='logreg',\n    use_raw=False\n)\n\n# Plot top markers\nsc.pl.rank_genes_groups(\n    adata_microglia,\n    n_genes=25,\n    sharey=False,\n    save='_quant_markers.pdf'\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nWARNING: saving figure to file figures/rank_genes_groups_leiden_integrated_quant_markers.pdf\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Differential expression analysis of integrated clusters. Plot shows the top 25 differentially expressed genes per cluster identified using Wilcoxon rank-sum test. Genes are ordered by average log fold change, and expression values are z-scored per gene.](eda_files/figure-jats/fig-cluster-markers-output-2.png){#fig-cluster-markers}\n:::\n:::\n\n\n::: {#cell-fig-heatmap-cluster-markers .cell execution_count=14}\n``` {}\n#| label: fig-heatmap-cluster-markers\n#| fig-cap: Differential expression analysis of integrated clusters. Heatmap shows the top 7 differentially expressed genes per cluster identified using Wilcoxon rank-sum test. Genes are ordered by average log fold change, and expression values are z-scored per gene.\n# Calculate dendrogram first\nsc.tl.dendrogram(adata_microglia, groupby='leiden_integrated')\n\n\n# Plot top markers\nsc.pl.rank_genes_groups_heatmap(\n    adata_microglia,\n    n_genes=7,\n    use_raw=False,\n    swap_axes=True,\n    show_gene_labels=True,\n    vmin=-3,\n    vmax=3,\n    cmap=\"bwr\",\n    layer=\"scaled\",\n    figsize=(21, 21),\n    show=False,\n);\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Differential expression analysis of integrated clusters. Heatmap shows the top 7 differentially expressed genes per cluster identified using Wilcoxon rank-sum test. Genes are ordered by average log fold change, and expression values are z-scored per gene.](eda_files/figure-jats/fig-heatmap-cluster-markers-output-1.png){#fig-heatmap-cluster-markers}\n:::\n:::\n\n\n::: {#cell-fig-dotplot-cluster-markers .cell execution_count=15}\n``` {}\n#| label: fig-dotplot-cluster-markers\n#| fig-cap: Differential expression analysis of integrated clusters. Dotplot shows the top 10 differentially expressed genes per cluster identified using Wilcoxon rank-sum test. Genes are ordered by average log fold change, , which are presented here.\n# Plot top DEG\nsc.pl.rank_genes_groups_dotplot(\n    adata_microglia,\n    n_genes=2,\n    values_to_plot=\"scores\",\n    min_logfoldchange=2,\n    vmax=1,\n    vmin=0,\n    cmap=\"gnuplot2_r\",\n    figsize=(24, 9),\n)\n```\n\n::: {.cell-output .cell-output-display}\n![Differential expression analysis of integrated clusters. Dotplot shows the top 10 differentially expressed genes per cluster identified using Wilcoxon rank-sum test. Genes are ordered by average log fold change, , which are presented here.](eda_files/figure-jats/fig-dotplot-cluster-markers-output-1.png){#fig-dotplot-cluster-markers}\n:::\n:::\n\n\n::: {#cell-fig-refined-marker-expression .cell execution_count=16}\n``` {}\n#| label: fig-refined-marker-expression\n#| fig-cap: Expression patterns of canonical microglial markers across refined clusters. UMAP visualizations showing the distribution of key microglial marker genes, revealing heterogeneous expression patterns across hypothalamic regions\n# Plot marker genes\nsc.pl.umap(\n    adata_microglia,\n    color=microglia_markers,\n    frameon=False,\n    show=True,\n    save='_integrated_markers.pdf'\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nWARNING: saving figure to file figures/umap_integrated_markers.pdf\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Expression patterns of canonical microglial markers across refined clusters. UMAP visualizations showing the distribution of key microglial marker genes, revealing heterogeneous expression patterns across hypothalamic regions](eda_files/figure-jats/fig-refined-marker-expression-output-2.png){#fig-refined-marker-expression}\n:::\n:::\n\n\n::: {#save-results .cell execution_count=17}\n``` {}\n#| label: save-results\n# Create output directories\noutput_dir = Path(\"output\")\noutput_dir.mkdir(exist_ok=True)\n\n# Save processed data\nadata_microglia.write(\n    output_dir / \"microglia_integrated.h5ad\",\n    compression=\"gzip\"\n)\n\n# Save cluster annotations\npd.DataFrame(adata_microglia.obs).to_csv(\n    output_dir / \"microglia_metadata.csv\"\n)\n```\n:::\n\n\n::: {#cell-fig-trem2-analysis .cell fig-height='8' fig-width='12' execution_count=18}\n``` {}\n#| label: fig-trem2-analysis\n#| fig-cap: 'Figure: Trem2 expression analysis across regions and microglial clusters. Panel (a) shows Trem2 expression by region (boxplot); panel (b) depicts Trem2 expression across clusters (violin plot); panel (c) displays a UMAP of Trem2 expression; panel (d) shows the correlation of Trem2 with other microglial markers.'\nimport numpy as np\nimport pandas as pd\nimport scanpy as sc\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\n# Analysis of Trem2 expression across regions\ndef analyze_trem2(adata):\n    # Get Trem2 expression data\n    trem2_expr = pd.DataFrame({\n        'Trem2': adata[:, 'Trem2'].X.toarray().flatten(),\n        'Region': adata.obs['region'],\n        'Dataset': adata.obs['bioproject'],\n        'Cluster': adata.obs['leiden_integrated']\n    })\n    \n    # Create a figure with multiple panels\n    fig = plt.figure(figsize=(15, 10))\n    \n    # 1. Boxplot of Trem2 expression by Region\n    plt.subplot(2, 2, 1)\n    sns.boxplot(data=trem2_expr, x='Region', y='Trem2')\n    plt.xticks(rotation=45, ha='right')\n    plt.title('Trem2 Expression by Region')\n    \n    # 2. Violin plot of Trem2 expression by Cluster\n    plt.subplot(2, 2, 2)\n    sns.violinplot(data=trem2_expr, x='Cluster', y='Trem2')\n    plt.xticks(rotation=45)\n    plt.title('Trem2 Expression by Microglial Cluster')\n    \n    # 3. UMAP colored by Trem2 expression\n    ax = plt.subplot(2, 2, 3)\n    sc.pl.umap(adata, color='Trem2', ax=ax, show=False)\n    plt.title('UMAP: Trem2 Expression')\n    \n    # 4. Correlation with other microglial markers\n    plt.subplot(2, 2, 4)\n    marker_correlations = []\n    for marker in microglia_markers:\n        if marker != 'Trem2' and marker in adata.var_names:\n            correlation = np.corrcoef(\n                adata[:, 'Trem2'].X.toarray().flatten(),\n                adata[:, marker].X.toarray().flatten()\n            )[0, 1]\n            marker_correlations.append((marker, correlation))\n    \n    marker_correlations = pd.DataFrame(marker_correlations, columns=['Marker', 'Correlation'])\n    marker_correlations = marker_correlations.sort_values('Correlation', ascending=True)\n    \n    sns.barplot(data=marker_correlations, x='Correlation', y='Marker')\n    plt.title('Correlation of Trem2 with Other Markers')\n    \n    plt.tight_layout()\n    plt.show()\n    plt.savefig(output_dir / 'trem2_analysis.pdf')\n    plt.close()\n    \n    return trem2_expr, marker_correlations\n\ntrem2_data, trem2_correlations = analyze_trem2(adata_microglia)\n```\n\n::: {.cell-output .cell-output-display}\n![Figure: Trem2 expression analysis across regions and microglial clusters. Panel (a) shows Trem2 expression by region (boxplot); panel (b) depicts Trem2 expression across clusters (violin plot); panel (c) displays a UMAP of Trem2 expression; panel (d) shows the correlation of Trem2 with other microglial markers.](eda_files/figure-jats/fig-trem2-analysis-output-1.png){#fig-trem2-analysis}\n:::\n:::\n\n\n::: {#cell-fig-trem2-region .cell execution_count=19}\n``` {}\n#| label: fig-trem2-region\n#| fig-cap: TREM2 expression levels across different hypothalamic regions. Box plots show the median, quartiles, and distribution of TREM2 expression in each anatomically distinct region. Whiskers extend to 1.5 times the interquartile range.\nplt.figure(figsize=(10, 6))\nsns.boxplot(data=trem2_data, x='Region', y='Trem2')\nplt.xticks(rotation=45, ha='right')\nplt.xlabel('Hypothalamic Region')\nplt.ylabel('TREM2 Expression Level')\nplt.title('Regional Distribution of TREM2 Expression')\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![TREM2 expression levels across different hypothalamic regions. Box plots show the median, quartiles, and distribution of TREM2 expression in each anatomically distinct region. Whiskers extend to 1.5 times the interquartile range.](eda_files/figure-jats/fig-trem2-region-output-1.png){#fig-trem2-region}\n:::\n:::\n\n\n::: {#cell-fig-trem2-clusters .cell execution_count=20}\n``` {}\n#| label: fig-trem2-clusters\n#| fig-cap: Distribution of TREM2 expression across identified microglial clusters. Violin plots demonstrate the full distribution of expression levels within each cluster, with embedded box plots showing median and quartile values.\nplt.figure(figsize=(10, 6))\nsns.violinplot(data=trem2_data, x='Cluster', y='Trem2')\nplt.xticks(rotation=45)\nplt.xlabel('Microglial Cluster')\nplt.ylabel('TREM2 Expression Level')\nplt.title('TREM2 Expression in Microglial Subpopulations')\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Distribution of TREM2 expression across identified microglial clusters. Violin plots demonstrate the full distribution of expression levels within each cluster, with embedded box plots showing median and quartile values.](eda_files/figure-jats/fig-trem2-clusters-output-1.png){#fig-trem2-clusters}\n:::\n:::\n\n\n::: {#fig-trem2-umap .cell execution_count=21}\n``` {}\n#| label: fig-trem2-umap\n#| fig-cap: UMAP visualization of TREM2 expression across all microglia. Color intensity represents TREM2 expression level, showing the spatial distribution of TREM2-expressing cells in the UMAP-reduced 2-dimensional space.\nplt.figure(figsize=(8, 8))\nsc.pl.umap(adata_microglia, color='Trem2', show=True, title='TREM2 Expression in UMAP Space')\nplt.tight_layout()\n```\n\n::: {#fig-trem2-umap-1 .cell-output .cell-output-display}\n```\n<Figure size 768x768 with 0 Axes>\n```\n\nUMAP visualization of TREM2 expression across all microglia. Color intensity represents TREM2 expression level, showing the spatial distribution of TREM2-expressing cells in the UMAP-reduced 2-dimensional space.\n:::\n\n::: {.cell-output .cell-output-display}\n![](eda_files/figure-jats/fig-trem2-umap-output-2.png){#fig-trem2-umap-2}\n:::\n\n::: {#fig-trem2-umap-3 .cell-output .cell-output-display}\n```\n<Figure size 672x480 with 0 Axes>\n```\n:::\n:::\n\n\n::: {#cell-fig-density-umap-scn .cell execution_count=22}\n``` {}\n#| label: fig-density-umap-scn\n#| fig-cap: Scatter plot visualization of SCN across all hypothalamic microglia. Color intensity represents density of microglia of SCN, showing the spatial distribution of Microglia in the UMAP-reduced 2-dimensional space.\nsc.pl.embedding_density(\n    adata_microglia, basis='umap', key='umap_density_region', group='SCN'\n)\n```\n\n::: {.cell-output .cell-output-display}\n![Scatter plot visualization of SCN across all hypothalamic microglia. Color intensity represents density of microglia of SCN, showing the spatial distribution of Microglia in the UMAP-reduced 2-dimensional space.](eda_files/figure-jats/fig-density-umap-scn-output-1.png){#fig-density-umap-scn}\n:::\n:::\n\n\n::: {#cell-fig-density-umap-pvn .cell execution_count=23}\n``` {}\n#| label: fig-density-umap-pvn\n#| fig-cap: Scatter plot visualization of PVN across all hypothalamic microglia. Color intensity represents density of microglia of PVN, showing the spatial distribution of Microglia in the UMAP-reduced 2-dimensional space.\nsc.pl.embedding_density(\n    adata_microglia, basis='umap', key='umap_density_region', group='PVN'\n)\n```\n\n::: {.cell-output .cell-output-display}\n![Scatter plot visualization of PVN across all hypothalamic microglia. Color intensity represents density of microglia of PVN, showing the spatial distribution of Microglia in the UMAP-reduced 2-dimensional space.](eda_files/figure-jats/fig-density-umap-pvn-output-1.png){#fig-density-umap-pvn}\n:::\n:::\n\n\n::: {#cell-fig-density-umap-poa .cell execution_count=24}\n``` {}\n#| label: fig-density-umap-poa\n#| fig-cap: Scatter plot visualization of POA across all hypothalamic microglia. Color intensity represents density of microglia of POA, showing the spatial distribution of Microglia in the UMAP-reduced 2-dimensional space.\nsc.pl.embedding_density(\n    adata_microglia, basis='umap', key='umap_density_region', group='POA'\n)\n```\n\n::: {.cell-output .cell-output-display}\n![Scatter plot visualization of POA across all hypothalamic microglia. Color intensity represents density of microglia of POA, showing the spatial distribution of Microglia in the UMAP-reduced 2-dimensional space.](eda_files/figure-jats/fig-density-umap-poa-output-1.png){#fig-density-umap-poa}\n:::\n:::\n\n\n::: {#cell-fig-dotplot-regions-markers .cell execution_count=25}\n``` {}\n#| label: fig-dotplot-regions-markers\n#| fig-cap: Differential expression analysis across regions. Dotplot shows the top 10 differentially expressed genes per region identified using Logistic Regression. Genes are ordered by average log fold change, which are presented here.\nsc.tl.rank_genes_groups(adata_microglia, groupby=\"region\", method=\"logreg\")\n\n# Plot top DEG\nsc.pl.rank_genes_groups_dotplot(\n    adata_microglia,\n    groupby=\"region\",\n    n_genes=10,\n    values_to_plot=\"scores\",\n    min_logfoldchange=5,\n    vmax=1,\n    vmin=0,\n    cmap=\"gnuplot2_r\",\n    figsize=(24, 9),\n)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\n/opt/conda/lib/python3.12/site-packages/sklearn/linear_model/_logistic.py:465: ConvergenceWarning:\n\nlbfgs failed to converge (status=1):\nSTOP: TOTAL NO. of ITERATIONS REACHED LIMIT.\n\nIncrease the number of iterations (max_iter) or scale the data as shown in:\n    https://scikit-learn.org/stable/modules/preprocessing.html\nPlease also refer to the documentation for alternative solver options:\n    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression\n\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nWARNING: dendrogram data not found (using key=dendrogram_region). Running `sc.tl.dendrogram` with default parameters. For fine tuning it is recommended to run `sc.tl.dendrogram` independently.\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Differential expression analysis across regions. Dotplot shows the top 10 differentially expressed genes per region identified using Logistic Regression. Genes are ordered by average log fold change, which are presented here.](eda_files/figure-jats/fig-dotplot-regions-markers-output-3.png){#fig-dotplot-regions-markers}\n:::\n:::\n\n\n::: {#cell-fig-trem2-correlations .cell execution_count=26}\n``` {}\n#| label: fig-trem2-correlations\n#| fig-cap: Correlation analysis between TREM2 and other microglial marker genes. Bar plot shows Pearson correlation coefficients, ordered by strength of correlation. Positive values indicate positive correlation, while negative values indicate inverse relationships.\nplt.figure(figsize=(10, 8))\nsns.barplot(data=trem2_correlations, x='Correlation', y='Marker')\nplt.title('TREM2 Correlation with Microglial Markers')\nplt.xlabel('Pearson Correlation Coefficient')\nplt.ylabel('Marker Gene')\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Correlation analysis between TREM2 and other microglial marker genes. Bar plot shows Pearson correlation coefficients, ordered by strength of correlation. Positive values indicate positive correlation, while negative values indicate inverse relationships.](eda_files/figure-jats/fig-trem2-correlations-output-1.png){#fig-trem2-correlations}\n:::\n:::\n\n\n::: {#trem2-statistics .cell execution_count=27}\n``` {}\n#| label: trem2-statistics\n#| output: false\nfrom scipy import stats\nimport statsmodels.stats.multitest as mt\n\ndef trem2_statistics(trem2_data):\n    # 1. One-way ANOVA for regional differences\n    regions_list = [group['Trem2'].values for name, group in trem2_data.groupby('Region')]\n    \n    # Check if we have enough groups for ANOVA\n    if len(regions_list) < 2:\n        print(\"Warning: Not enough regions for ANOVA\")\n        f_stat, p_val = np.nan, np.nan\n    else:\n        f_stat, p_val = stats.f_oneway(*regions_list)\n    \n    # 2. Pairwise t-tests between regions\n    unique_regions = sorted(trem2_data['Region'].unique())\n    pairwise_tests = []\n    \n    for i in range(len(unique_regions)):\n        for j in range(i+1, len(unique_regions)):\n            reg1 = unique_regions[i]\n            reg2 = unique_regions[j]\n            \n            data1 = trem2_data[trem2_data['Region'] == reg1]['Trem2']\n            data2 = trem2_data[trem2_data['Region'] == reg2]['Trem2']\n            \n            # Only perform test if both groups have data\n            if len(data1) > 0 and len(data2) > 0:\n                t_stat, p_val = stats.ttest_ind(data1, data2)\n                \n                # Calculate effect size (Cohen's d)\n                pooled_std = np.sqrt(\n                    ((len(data1) - 1) * data1.std()**2 + \n                     (len(data2) - 1) * data2.std()**2) / \n                    (len(data1) + len(data2) - 2)\n                )\n                cohens_d = (data1.mean() - data2.mean()) / pooled_std\n                \n                pairwise_tests.append({\n                    'Region1': reg1,\n                    'Region2': reg2,\n                    'Mean1': data1.mean(),\n                    'Mean2': data2.mean(),\n                    'N1': len(data1),\n                    'N2': len(data2),\n                    't_statistic': t_stat,\n                    'p_value': p_val,\n                    'cohens_d': cohens_d\n                })\n    \n    # Apply Benjamini-Hochberg correction to p-values\n    if pairwise_tests:\n        pairwise_df = pd.DataFrame(pairwise_tests)\n        _, p_adjusted, _, _ = mt.multipletests(\n            pairwise_df['p_value'].values,\n            method='fdr_bh'\n        )\n        pairwise_df['p_value_adj'] = p_adjusted\n        \n        # Sort by adjusted p-value\n        pairwise_df = pairwise_df.sort_values('p_value_adj')\n    else:\n        pairwise_df = pd.DataFrame()\n    \n    # Create results dictionary\n    stats_results = {\n        'anova': {'f_statistic': f_stat, 'p_value': p_val},\n        'pairwise_tests': pairwise_df\n    }\n    \n    # Save results with more detailed formatting\n    with open(output_dir / 'trem2_statistics.txt', 'w') as f:\n        f.write('TREM2 Expression Analysis Across Hypothalamic Regions\\n')\n        f.write('='*50 + '\\n\\n')\n        \n        f.write('1. One-way ANOVA results:\\n')\n        f.write('-'*30 + '\\n')\n        f.write(f'F-statistic: {f_stat:.4f}\\n')\n        f.write(f'p-value: {p_val:.4e}\\n\\n')\n        \n        f.write('2. Regional Expression Summary:\\n')\n        f.write('-'*30 + '\\n')\n        summary_stats = trem2_data.groupby('Region')['Trem2'].agg(['count', 'mean', 'std'])\n        f.write(summary_stats.to_string() + '\\n\\n')\n        \n        f.write('3. Pairwise Comparisons:\\n')\n        f.write('-'*30 + '\\n')\n        if not pairwise_df.empty:\n            # Format floating point numbers\n            formatted_df = pairwise_df.copy()\n            float_cols = ['Mean1', 'Mean2', 't_statistic', 'p_value', 'p_value_adj', 'cohens_d']\n            for col in float_cols:\n                formatted_df[col] = formatted_df[col].map('{:.4e}'.format)\n            f.write(formatted_df.to_string())\n    \n    return stats_results\n\n# Run the analysis\ntrem2_stats = trem2_statistics(trem2_data)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\n/tmp/ipykernel_27977/3657118994.py:6: FutureWarning:\n\nThe default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n\n/tmp/ipykernel_27977/3657118994.py:83: FutureWarning:\n\nThe default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n\n```\n:::\n:::\n\n\n::: {#cell-fig-trem2-regional-stats .cell execution_count=28}\n``` {}\n#| label: fig-trem2-regional-stats\n#| fig-cap: Statistical comparison of TREM2 expression across hypothalamic regions. Box plots show the distribution of TREM2 expression levels in each region. Significance bars indicate the top 5 most significant pairwise comparisons (FDR-corrected p-values). Cohen's d effect sizes are shown for each comparison, quantifying the magnitude of expression differences between regions.\n# Create visualization of the statistical results\nplt.figure(figsize=(12, 8))\nsns.boxplot(data=trem2_data, x='Region', y='Trem2')\nplt.xticks(rotation=45, ha='right')\nplt.xlabel('Hypothalamic Region')\nplt.ylabel('TREM2 Expression Level')\nplt.title('Regional TREM2 Expression with Statistical Comparisons')\n\n# Add significance annotations for top significant comparisons\nif not trem2_stats['pairwise_tests'].empty:\n    max_y = trem2_data['Trem2'].max()\n    y_pos = max_y * 1.1\n    \n    # Get top 5 most significant comparisons\n    top_comparisons = trem2_stats['pairwise_tests'].head(5)\n    \n    # Get ordered list of regions for proper indexing\n    region_order = pd.Categorical(trem2_data['Region']).categories\n    \n    for idx, row in top_comparisons.iterrows():\n        try:\n            # Find indices in the ordered region list\n            x1 = np.where([r == row['Region1'] for r in region_order])[0][0]\n            x2 = np.where([r == row['Region2'] for r in region_order])[0][0]\n            \n            plt.plot([x1, x2], [y_pos, y_pos], 'k-', linewidth=1)\n            plt.text((x1 + x2) / 2, y_pos * 1.05,\n                    f\"p={row['p_value_adj']:.1e}\\nd={row['cohens_d']:.2f}\",\n                    ha='center', va='bottom')\n            y_pos += max_y * 0.1\n        except IndexError:\n            continue\n\nplt.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![Statistical comparison of TREM2 expression across hypothalamic regions. Box plots show the distribution of TREM2 expression levels in each region. Significance bars indicate the top 5 most significant pairwise comparisons (FDR-corrected p-values). Cohen's d effect sizes are shown for each comparison, quantifying the magnitude of expression differences between regions.](eda_files/figure-jats/fig-trem2-regional-stats-output-1.png){#fig-trem2-regional-stats}\n:::\n:::\n\n\n::: {#cell-fig-trem2-cluster-enrichment-heatmap .cell execution_count=29}\n``` {}\n#| label: fig-trem2-cluster-enrichment-heatmap\n#| fig-cap: Regional and cluster-specific TREM2 expression patterns. Heatmap shows mean TREM2 expression levels across different microglial clusters (rows) and hypothalamic regions (columns). Color intensity represents expression level, with darker colors indicating higher expression.\ndef analyze_trem2_clusters(adata):\n    cluster_means = pd.DataFrame({\n        'Trem2_mean': adata[:, 'Trem2'].X.toarray().flatten(),\n        'Cluster': adata.obs['leiden_integrated'],\n        'Region': adata.obs['region']\n    }).groupby(['Cluster', 'Region'])['Trem2_mean'].mean().reset_index()\n    \n    pivot_table = cluster_means.pivot(\n        index='Cluster',\n        columns='Region',\n        values='Trem2_mean'\n    )\n    \n    plt.figure(figsize=(12, 8))\n    sns.heatmap(pivot_table, cmap='viridis', annot=True, fmt='.2f', \n                cbar_kws={'label': 'Mean TREM2 Expression'})\n    plt.title('TREM2 Expression Across Microglial Clusters and Regions')\n    plt.xlabel('Hypothalamic Region')\n    plt.ylabel('Microglial Cluster')\n    plt.tight_layout()\n    \n    return cluster_means\n\ntrem2_cluster_data = analyze_trem2_clusters(adata_microglia)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\n/tmp/ipykernel_27977/1971043812.py:6: FutureWarning:\n\nThe default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Regional and cluster-specific TREM2 expression patterns. Heatmap shows mean TREM2 expression levels across different microglial clusters (rows) and hypothalamic regions (columns). Color intensity represents expression level, with darker colors indicating higher expression.](eda_files/figure-jats/fig-trem2-cluster-enrichment-heatmap-output-2.png){#fig-trem2-cluster-enrichment-heatmap}\n:::\n:::\n\n\n::: {#cell-fig-trem2-coexpression-network .cell execution_count=30}\n``` {}\n#| label: fig-trem2-coexpression-network\n#| fig-cap: TREM2 co-expression network in hypothalamic microglia. Nodes represent genes, with TREM2 as the central hub. Edge weights represent the absolute Pearson correlation coefficient between gene pairs. Only correlations above 0.3 are shown.\nimport networkx as nx\nimport matplotlib.pyplot as plt\nimport scipy.sparse\nimport numpy as np\nimport pandas as pd\n\ndef create_trem2_network(adata, correlation_threshold=0.5):\n    \"\"\"\n    Create and visualize a TREM2-centered gene co-expression network.\n    \n    Parameters:\n    -----------\n    adata : AnnData\n        Annotated data matrix containing gene expression data\n    correlation_threshold : float\n        Minimum absolute correlation coefficient to include in the network\n        \n    Returns:\n    --------\n    G : networkx.Graph\n        Network graph object containing the co-expression relationships\n    \"\"\"\n    # Verify Trem2 is in the dataset\n    if 'Trem2' not in adata.var_names:\n        raise ValueError(\"Trem2 gene not found in the dataset\")\n    \n    try:\n        # Get expression matrix - handle both sparse and dense formats\n        if scipy.sparse.issparse(adata.X):\n            expr_matrix = adata.X.toarray()\n        else:\n            expr_matrix = np.array(adata.X)\n        \n        # Verify matrix is not empty and contains valid values\n        if expr_matrix.size == 0 or np.all(np.isnan(expr_matrix)):\n            raise ValueError(\"Expression matrix is empty or contains invalid values\")\n        \n        # Calculate correlation matrix for genes\n        correlation_matrix = pd.DataFrame(\n            np.corrcoef(expr_matrix.T),\n            index=adata.var_names,\n            columns=adata.var_names\n        )\n        \n        # Create network\n        G = nx.Graph()\n        \n        # Add edges for genes correlated with Trem2\n        trem2_correlations = correlation_matrix['Trem2'].abs()\n        \n        # Filter and add edges\n        for gene in trem2_correlations.index:\n            if gene != 'Trem2' and trem2_correlations[gene] > correlation_threshold:\n                G.add_edge('Trem2', gene, weight=float(trem2_correlations[gene]))\n        \n        # Check if network is empty\n        if len(G.nodes()) < 2:\n            print(\"Warning: No genes pass correlation threshold\")\n            return G\n        \n        # Calculate node sizes based on degree centrality\n        degree_centrality = nx.degree_centrality(G)\n        node_sizes = [3000 * (degree_centrality[node] + 0.1) for node in G.nodes()]\n        \n        # Calculate edge weights for visualization\n        edge_weights = [G[u][v]['weight'] * 2 for u, v in G.edges()]\n        \n        # Create color map based on correlation with TREM2\n        node_colors = ['#ff7f0e' if node == 'Trem2' else '#1f77b4' for node in G.nodes()]\n        \n        # Create new figure\n        plt.figure(figsize=(12, 12))\n        \n        # Calculate layout\n        pos = nx.spring_layout(G, k=1, iterations=50, seed=42)\n        \n        # Draw network components\n        nx.draw_networkx_edges(\n            G, pos,\n            width=edge_weights,\n            alpha=0.5,\n            edge_color='gray'\n        )\n        \n        nx.draw_networkx_nodes(\n            G, pos,\n            node_size=node_sizes,\n            node_color=node_colors,\n            alpha=0.7\n        )\n        \n        nx.draw_networkx_labels(\n            G, pos,\n            font_size=10,\n            font_weight='bold',\n            font_color='black'\n        )\n        \n        plt.title('TREM2 Co-expression Network', \n                 pad=20, size=14, weight='bold')\n        \n        # Add legend with explicit handles\n        legend_elements = [\n            plt.Line2D([0], [0], marker='o', color='w', \n                      markerfacecolor='#ff7f0e', label='TREM2', markersize=10),\n            plt.Line2D([0], [0], marker='o', color='w', \n                      markerfacecolor='#1f77b4', label='Co-expressed genes', markersize=10)\n        ]\n        plt.legend(handles=legend_elements, loc='upper right', bbox_to_anchor=(1.15, 1.15))\n        \n        plt.axis('off')\n        plt.tight_layout()\n        plt.show()\n        \n        # Save figure\n        plt.savefig(output_dir / 'trem2_network.pdf', bbox_inches='tight', dpi=300)\n        plt.close()\n        \n        return G\n        \n    except Exception as e:\n        print(f\"Error in network creation: {str(e)}\")\n        return None\n\n# Create network with improved error handling\ntry:\n    trem2_network = create_trem2_network(adata_microglia)\n    \n    if trem2_network is not None:\n        print(\"\\nNetwork Statistics:\")\n        print(f\"Number of co-expressed genes: {len(trem2_network.nodes()) - 1}\")\n        print(f\"Number of connections: {len(trem2_network.edges())}\")\n        \n        # Calculate and print additional network metrics\n        print(\"\\nNetwork Metrics:\")\n        print(f\"Network density: {nx.density(trem2_network):.3f}\")\n        print(f\"Average clustering coefficient: {nx.average_clustering(trem2_network):.3f}\")\n        \nexcept Exception as e:\n    print(f\"Failed to create network: {str(e)}\")\n```\n\n::: {.cell-output .cell-output-display}\n![TREM2 co-expression network in hypothalamic microglia. Nodes represent genes, with TREM2 as the central hub. Edge weights represent the absolute Pearson correlation coefficient between gene pairs. Only correlations above 0.3 are shown.](eda_files/figure-jats/fig-trem2-coexpression-network-output-1.png){#fig-trem2-coexpression-network}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nNetwork Statistics:\nNumber of co-expressed genes: 10\nNumber of connections: 10\n\nNetwork Metrics:\nNetwork density: 0.182\nAverage clustering coefficient: 0.000\n```\n:::\n:::\n\n\n",
    "supporting": [
      "eda_files/figure-jats"
    ],
    "filters": []
  }
}